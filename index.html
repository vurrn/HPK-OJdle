<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPK OJdle</title>
    <style>
        h1, h2, h3, p, .centerContainer {
            text-align: center;
            color: white;
        }
        h1 {
            font-family: 'Arial';
            font-size: 48px;
            margin-bottom: 0px;
        }
        table {
            margin: auto;
            width: 1280px;
            table-layout: fixed;
        }
        tr {
            border: 1px solid #A0A0A0;
            padding: 8px;
            text-align: center;
            color: white;
        }
        th {
            border: 1px solid #A0A0A0;
            padding: 8px;
            height: 20px;
            text-align: center;
            color: white;
        }
        td {
            border: 1px solid #A0A0A0;
            padding: 8px;
            height: 36px;
            text-align: center;
            color: white;
        }
        th:nth-child(1), td:nth-child(1) {
            width: 220px;
        }
        th:nth-child(2), td:nth-child(2) {
            width: 60px;
        }
        th:nth-child(3), td:nth-child(3) {
            width: 80px;
        }
        th:nth-child(5), td:nth-child(5) {
            width: 90px;
        }
        th:nth-child(6), td:nth-child(6) {
            width: 170px;
        }
        th:nth-child(7), td:nth-child(7) {
            width: 110px;
        }
        th:nth-child(8), td:nth-child(8) {
            width: 70px;
        }
    </style>
</head>
<body style="background-color: #333333">
    <input type="checkbox" id="colorblindMode" onclick="toggleColorblind()">
    <label for="colorblindMode" style="color: white">Colorblind mode</label>
    <h1 style="margin-top: 0px;"><b>HPK OJdle</b></h1>
    <p id="legendText">游린 Incorrect/no match | 游릳 Partial match | 游릴 Correct/perfect match | 拘勇 Correct value is higher | 拘勇 Correct value is lower</p>
    <table id="guessTable">
        <tr>
            <th>Jump Name</th>
            <th>OJ ID</th>
            <th>Difficulty</th>
            <th>Tags</th>
            <th>Clear Rate</th>
            <th>Series</th>
            <th>Verifier</th>
            <th>Airtime</th>
        </tr>
    </table>
    <div id="guessArea" class="centerContainer">
        <form id="searchForm">
            <h3 id="attemptCounter">Attempts: 0/6</h3>
            <label for="jumpInput">Enter a jump:</label>
            <input type="text" id="jumpInput" size="40" list="jumpList" placeholder="Enter jump name">
            <datalist id="jumpList"></datalist>
            <button type="submit" id="enter">Enter</button>
        </form>
    </div>
    
    <div id="resultSection" class="centerContainer">
        <p id="commentValue"></p>
        <p id="test"></p>
    </div>

    <script>
        let attempt = 1;
        let resultText = "";
        let game = true;
        let colorblindMode = false;

        const currentDate = new Date();
        let currentDay = Math.floor((currentDate.getTime() / 60000 - currentDate.getTimezoneOffset()) / 1440);
        if (currentDay < 20353) {
            currentDay = 20353;
        }

        // Get DOM elements
        const legendText = document.getElementById('legendText');
        const guessTable = document.getElementById('guessTable');
        const searchForm = document.getElementById('searchForm');
        const jumpInput = document.getElementById('jumpInput');
        const jumpListDatalist = document.getElementById('jumpList');
        const commentValue = document.getElementById('commentValue');
        const attemptCounter = document.getElementById('attemptCounter');
        const resultSection = document.getElementById('resultSection');
        
        // Add rows and data cells to the table
        for (let row = 1; row < 7; row++) {
            let tr = document.createElement('tr');
            for (let data = 1; data < 9; data ++) {
                let td = document.createElement('td')
                td.id = `r${row}d${data}`
                tr.appendChild(td)
            }
            guessTable.appendChild(tr)
        }

        // Mulberry32 PRNG
        function seededRandom(seed) {
            seed |= 0; // Ensure seed is a 32-bit integer
            seed = (seed + 0x6D2B79F5) | 0;
            let t = Math.imul(seed ^ (seed >>> 15), 1 | seed);
            t = (t + Math.imul(t ^ (t >>> 13), 1 | t)) | 0;
            return ((t ^ (t >>> 16)) >>> 0) / 4294967296; // Normalize to [0, 1)
        }

        // Variable to store the loaded JSON data
        let jumpData = {};
        
        // Fetch the JSON file
        fetch('jumpData.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                jumpData = data;
                console.log('JSON data loaded successfully');
                // Populate the jumpList datalist
                for (const key in jumpData) {
                    if (jumpData.hasOwnProperty(key)) {
                        const option = document.createElement('option');
                        option.value = key;
                        jumpListDatalist.appendChild(option);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading JSON data:', error);
                commentValue.textContent = 'Error loading JSON data: ' + error.message;
            });
        
        // Handle form submission
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedJump = jumpInput.value.trim();
            const randIndex = Math.round(seededRandom(currentDay) * (Object.keys(jumpData).length - 0.5));
            if (randIndex === Object.keys(jumpData).length) {
                randIndex--
            }
            const correctJump = Object.keys(jumpData)[randIndex];
            
            if (selectedJump.length === 0 && game) {
                commentValue.textContent = "Please enter a valud jump.";
                return;
            }
            
            if (Object.keys(jumpData).length === 0) {
                commentValue.textContent = "JSON data is still loading, please try again shortly";
                return;
            }
            
            if (jumpData.hasOwnProperty(selectedJump)) {
                // Filling in the guess table and final result to copy
                let td = document.getElementById(`r${attempt}d1`);
                let check = checkName(selectedJump, correctJump);
                td.textContent = selectedJump;
                td.setAttribute("style", `background-color: ${check[0]}`)
                resultText += "\n" + check[1];

                td = document.getElementById(`r${attempt}d2`);
                check = checkID(selectedJump, correctJump);
                td.textContent = jumpData[selectedJump]['id'] + check[2];
                td.setAttribute("style", `background-color: ${check[0]}`);
                resultText += check[1];

                td = document.getElementById(`r${attempt}d3`);
                check = checkDifficulty(selectedJump, correctJump);
                let difficulty = jumpData[selectedJump]['difficulty'].toString();
                // Replacing decimal point with -/=/+
                if (difficulty.slice(-2) === '.2') {
                    difficulty = difficulty.slice(0, -2) + '+';
                } else if (difficulty.slice(-2) === '.1') {
                    difficulty = difficulty.slice(0, -2) + '=';
                } else {
                    difficulty += '-';
                }
                td.textContent = difficulty + check[2];
                td.setAttribute("style", `background-color: ${check[0]}`);
                resultText += check[1];

                td = document.getElementById(`r${attempt}d4`);
                check = checkTags(selectedJump, correctJump);
                td.textContent = jumpData[selectedJump]['tags'].join(", ");
                td.setAttribute("style", `background-color: ${check[0]}`);
                resultText += check[1];

                td = document.getElementById(`r${attempt}d5`);
                check = checkClearRate(selectedJump, correctJump);
                td.textContent = jumpData[selectedJump]['clearrate'] + "%" + check[2];
                td.setAttribute("style", `background-color: ${check[0]}`);
                resultText += check[1];

                td = document.getElementById(`r${attempt}d6`);
                check = checkSeries(selectedJump, correctJump);
                td.textContent = jumpData[selectedJump]['series'].join(", ");
                td.setAttribute("style", `background-color: ${check[0]}`);
                resultText += check[1];

                td = document.getElementById(`r${attempt}d7`);
                check = checkVerifier(selectedJump, correctJump);
                td.textContent = jumpData[selectedJump]['verifier'];
                td.setAttribute("style", `background-color: ${check[0]}`);
                resultText += check[1];

                td = document.getElementById(`r${attempt}d8`);
                check = checkAirtime(selectedJump, correctJump);
                td.textContent = jumpData[selectedJump]['airtime'] + check[2];
                td.setAttribute("style", `background-color: ${check[0]}`);
                resultText += check[1];

                attemptCounter.textContent = `Attempts: ${attempt}/6`;

                if (selectedJump === correctJump || attempt === 6) {
                    const submitButton = document.getElementById('enter');
                    submitButton.removeAttribute('type');
                    jumpInput.removeAttribute('id');
                    jumpInput.removeAttribute('list');
                    jumpInput.setAttribute('readonly', true);
                    commentValue.textContent = getComment(attempt) + ` Guessed the jump in ${attempt}/6 attempts.`;
                    const shareButton = document.createElement('button');
                    shareButton.setAttribute('onclick', 'copyResults()')
                    shareButton.textContent = "Share";
                    resultSection.appendChild(shareButton);
                    game = false;
                }
                if (selectedJump != correctJump) {
                    attempt++
                    if (attempt === 7) {
                        attempt = "X";
                        attemptCounter.textContent = "Attempts: X/6";
                        commentValue.textContent = `Yikes! The correct jump was "${correctJump}"`
                    }
                }
            } else {
                if (game) {
                    commentValue.textContent = `"${selectedJump}" not found in the jump data.`;
                }
            }
            jumpInput.value = "";
        });

        function getComment(attempts) {
            switch (attempts) {
                case 1:
                    return "You probably cheated or you're RNG carried af."
                    break;
                case 2:
                    return "You might be GOATED."
                    break;
                case 3:
                    return "You probably lost a 50/50, unlucky!"
                    break;
                case 4:
                    return "You did it, great job!"
                    break;
                case 5:
                    return "Not bad."
                    break;
                case 6:
                    return "Phew! That was a close one."
                    break;
            }
        }

        function copyResults() {
            let textToCopy = "";
            if (colorblindMode) {
                textToCopy = resultText.replace(/游릳/g, '游릱');
                textToCopy = textToCopy.replace(/游릴/g, '游릳');
            } else {
                textToCopy = resultText;
            }
            // Use the Clipboard API to write the text to the clipboard
            navigator.clipboard.writeText(`HPK OJdle ${currentDay-20352} - ${attempt}/6${textToCopy}\nhttps://vurrn.github.io/hpk-ojdle/`)
                .then(() => {
                    alert('Copied results to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy result: ', err);
                    alert('Failed to copy text.');
                });
        }

        function toggleColorblind() {
            colorblindMode = !colorblindMode;
            if (colorblindMode) {
                legendText.textContent = "游린 Incorrect/no match | 游릱 Partial match | 游릳 Correct/perfect match | 拘勇 Correct value is higher | 拘勇 Correct value is lower";
            } else {
                legendText.textContent = "游린 Incorrect/no match | 游릳 Partial match | 游릴 Correct/perfect match | 拘勇 Correct value is higher | 拘勇 Correct value is lower";
            }
            rowLoop: for (row = 1; row < 7; row++) {
                for (data = 1; data < 9; data++) {
                    const cell = document.getElementById(`r${row}d${data}`);
                    let cellColor = cell.getAttribute('style');
                    if (cellColor === null) {
                        break rowLoop;
                    } else {
                        cellColor = cellColor.slice(-7);
                    }
                    cell.setAttribute('style', `background-color: ${changeHex(cellColor)}`);
                }
            }
        }

        function changeHex(color) {
                switch (color) {
                    case "#EE0000":
                        return "#F03060";
                        break;
                    case "#EEA000":
                        return "#4080F0";
                        break;
                    case "#00B000":
                        return "#FFC040";
                        break;
                    case "#F03060":
                        return "#EE0000";
                        break;
                    case "#4080F0":
                        return "#EEA000";
                        break;
                    case "#FFC040":
                        return "#00B000";
                        break;
            }
        }

        function checkName(guess, correct) {
            let returnValue = [];
            if (guess === correct) {
                returnValue =  ["#00B000", "游릴"];
            } else {
                returnValue =  ["#EE0000", "游린"];
            }
            if (colorblindMode) {
                returnValue[0] = changeHex(returnValue[0]);
            }
            return returnValue;
        }

        function checkID(guess, correct) {
            let returnValue = [];
            if (jumpData[guess]['id'] < jumpData[correct]['id']) {
                returnValue =  ["#EE0000", "游린", " 拘勇"];
            } else if (jumpData[guess]['id'] > jumpData[correct]['id']) {
                returnValue =  ["#EE0000", "游린", " 拘勇"];
            } else {
                returnValue =  ["#00B000", "游릴", ""];
            }
            if (colorblindMode) {
                returnValue[0] = changeHex(returnValue[0]);
            }
            return returnValue;
        }

        function checkDifficulty(guess, correct) {
            let returnValue = [];
            if (jumpData[guess]['difficulty'] < jumpData[correct]['difficulty']) {
                returnValue =  ["#EE0000", "游린", " 拘勇"];
            } else if (jumpData[guess]['difficulty'] > jumpData[correct]['difficulty']) {
                returnValue =  ["#EE0000", "游린", " 拘勇"];
            } else {
                returnValue =  ["#00B000", "游릴", ""];
            }
            if (colorblindMode) {
                returnValue[0] = changeHex(returnValue[0]);
            }
            return returnValue;
        }

        function checkTags(guess, correct) {
            let returnValue = [];
            let guessTag = jumpData[guess]['tags'];
            let correctTag = jumpData[correct]['tags'];
            guessTag = guessTag.join();
            correctTag = correctTag.join();
            if (guessTag === correctTag) {
                returnValue =  ["#00B000", "游릴"];
            } else {
                let foundTag = false;
                for (const tag of jumpData[guess]['tags']) {
                    console.log(tag);
                    if (jumpData[correct]['tags'].includes(tag)) {
                        foundTag = true;
                        break;
                    }
                }
                if (foundTag) {
                    returnValue =  ["#EEA000", "游릳"];
                } else {
                    returnValue =  ["#EE0000", "游린"];
                }
            }
            if (colorblindMode) {
                returnValue[0] = changeHex(returnValue[0]);
            }
            return returnValue;
        }

        function checkClearRate(guess, correct) {
            let returnValue = [];
            if (jumpData[guess]['clearrate'] < jumpData[correct]['clearrate']) {
                returnValue =  ["#EE0000", "游린", " 拘勇"];
            } else if (jumpData[guess]['clearrate'] > jumpData[correct]['clearrate']) {
                returnValue =  ["#EE0000", "游린", " 拘勇"];
            } else {
                returnValue =  ["#00B000", "游릴", ""];
            }
            if (colorblindMode) {
                returnValue[0] = changeHex(returnValue[0]);
            }
            return returnValue;
        }

        function checkSeries(guess, correct) {
            let returnValue = [];
            let guessSeries = jumpData[guess]['series'];
            let correctSeries = jumpData[correct]['series'];
            guessSeries = guessSeries.join();
            correctSeries = correctSeries.join();
            if (guessSeries === correctSeries) {
                returnValue =  ["#00B000", "游릴"];
            } else {
                let foundSeries = false;
                for (const series of jumpData[guess]['series']) {
                    if (jumpData[correct]['series'].includes(series)) {
                        foundSeries = true;
                        break;
                    }
                }
                if (foundSeries) {
                    returnValue =  ["#EEA000", "游릳"];
                } else {
                    returnValue =  ["#EE0000", "游린"];
                }
            }
            if (colorblindMode) {
                returnValue[0] = changeHex(returnValue[0]);
            }
            return returnValue;
        }

        function checkVerifier(guess, correct) {
            let returnValue = [];
            if (jumpData[guess]['verifier'] === jumpData[correct]['verifier']) {
                returnValue =  ["#00B000", "游릴"];
            } else {
                returnValue =  ["#EE0000", "游린"];
            }
            if (colorblindMode) {
                returnValue[0] = changeHex(returnValue[0]);
            }
            return returnValue;
        }

        function checkAirtime(guess, correct) {
            let returnValue = [];
            if (jumpData[guess]['airtime'] < jumpData[correct]['airtime']) {
                returnValue =  ["#EE0000", "游린", " 拘勇"];
            } else if (jumpData[guess]['airtime'] > jumpData[correct]['airtime']) {
                returnValue =  ["#EE0000", "游린", " 拘勇"];
            } else {
                returnValue =  ["#00B000", "游릴", ""];
            }
            if (colorblindMode) {
                returnValue[0] = changeHex(returnValue[0]);
            }
            return returnValue;
        }
    </script>
</html>

